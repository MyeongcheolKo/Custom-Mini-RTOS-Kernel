/*
 * I2C_master_send_arduino.c
 *
 *  Created on: Dec 31, 2025
 *      Author: krisko
 */

#include <string.h>
#include "drivers.h"

/*
 * This sample application have STM32F446RE (Master) sending a command byte (67) to Arduino Uno (Slave), and
 * Arduino responds with 0xF5 as acknowledgement if it verifies it receives 67, the correct command.
 * STM32 then blinks LD2 LED if it receives the valid acknowledgement (0xF5).
 *
 * pins used:
 * PB6 - I2C1_SCL
 * PB7 - I2C1_SDA
 * GPIO alternate function mode: 4
 *
 * connection with arduino:
 * PB6 (I2C1_SCL) - arduino pin A4
 * PB7 (I2C1_SDA) - arduino pin A5
 * STm32 GND - arduino GND

 *
 * note: use a logic level converter to avoid data corruption due to VOH and VIH mismatch
 */

#define BUTTON_PRESSED 	0
#define SLAVE_ADDR 		0x68

I2C_Handle_t I2C1_Handle;

void I2C_GPIO_inits(void)
{
	GPIO_Handle_t I2C_pins;

	//pin configuration generic to all SPI pins
	I2C_pins.p_GPIOx = GPIOB;
	I2C_pins.GPIO_config.GPIO_pin_mode = GPIO_MODE_ALTFUNC;
	I2C_pins.GPIO_config.GPIO_pin_alt_fcn_mode = 4;
	I2C_pins.GPIO_config.GPIO_pin_out_type = GPIO_OUT_TYPE_OD;
	I2C_pins.GPIO_config.GPIO_pin_speed = GPIO_OUT_SPEED_FAST;
	I2C_pins.GPIO_config.GPIO_pin_pupd = GPIO_PIN_NO_PUPD;

	//SCL
	I2C_pins.GPIO_config.GPIO_pin_num = GPIO_PIN_NO_6;
	GPIO_init(&I2C_pins);

	//SCL
	I2C_pins.GPIO_config.GPIO_pin_num = GPIO_PIN_NO_7;
	GPIO_init(&I2C_pins);
}

void GPIO_button_init(void)
{
	GPIO_Handle_t GPIO_button;
	//button configuration
	GPIO_button.p_GPIOx = GPIOC; 	//B1 is connected to PC13
	GPIO_button.GPIO_config.GPIO_pin_num = GPIO_PIN_NO_13;
	GPIO_button.GPIO_config.GPIO_pin_mode = GPIO_MODE_IN;
	GPIO_button.GPIO_config.GPIO_pin_pupd = GPIO_PIN_NO_PUPD;
	GPIO_init(&GPIO_button);
}

void GPIO_LED_init(void)
{
	GPIO_Handle_t GPIO_led;
	//LED configuration
	GPIO_led.p_GPIOx = GPIOA; 	//LD2 is connected to PA5
	GPIO_led.GPIO_config.GPIO_pin_num = GPIO_PIN_NO_5;
	GPIO_led.GPIO_config.GPIO_pin_mode = GPIO_MODE_OUT;
	GPIO_led.GPIO_config.GPIO_pin_speed = GPIO_OUT_SPEED_FAST;
	GPIO_led.GPIO_config.GPIO_pin_out_type = GPIO_OUT_TYPE_PP;
	GPIO_led.GPIO_config.GPIO_pin_pupd = GPIO_PIN_NO_PUPD;
	GPIO_init(&GPIO_led);
}

void delay(void)
{
	for(uint32_t i = 0; i < 500000; i++);
}

void I2C1_inits(void)
{
	I2C1_Handle.p_I2Cx = I2C1;
	I2C1_Handle.I2Cx_config.I2C_ACK_control = I2C_ACK_DISABlE;
	I2C1_Handle.I2Cx_config.I2C_CLK_speed = I2C_CLK_SPEED_SM;
	I2C1_Handle.I2Cx_config.I2C_FM_duty_cycle = I2C_FM_DUTY_2;
	I2C1_Handle.I2Cx_config.I2C_addr_mode = I2C_ADDR_MODE_7BITS;
	I2C1_Handle.I2Cx_config.I2C_device_addr = 0x67;

	I2C_init(&I2C1_Handle);
}

int main(void)
{
	//initialize the GPIO pins to behave as I2C1 pins
	I2C_GPIO_inits();
	//initialize the B1 button
	GPIO_button_init();
	//initialize the L2 LED
	GPIO_LED_init();
	//configure the I2C1 parameters

	I2C1_inits();
	//enable I2C1
	I2C_periph_control(I2C1, ENABLE);

	uint8_t send_data[] = "Testing I2C master send";
	uint8_t len = strlen((char*)send_data);
	while(1)
	{
		while(GPIO_read_input_pin(GPIOC, GPIO_PIN_NO_13));
		delay();

		//send data to slave
		I2C_Master_send(I2C1_Handle, send_data, len, SLAVE_ADDR);
	}



	return 0;
}

